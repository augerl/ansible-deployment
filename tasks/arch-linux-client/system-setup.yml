---
- name: Install cron & pip package
  package:
    name:
      - git
      - base-devel
      - cronie
      - python-psutil
    state: latest

- name: start and enable cronie daemon
  service:
    name: cronie
    state: started
    enabled: true

#- name: Check if pip externally managed file exists
#  stat:
#    path: "/usr/lib/python3.11/EXTERNALLY-MANAGED"
#  register: externally_managed_status

#- name: remove pip externally managed
#  become: true
#  command: rm /usr/lib/python3.11/EXTERNALLY-MANAGED
#  when: externally_managed_status.stat.exists == true

#- name: Install psutil python-pip package
#  pip:
#    name: psutil
#    extra_args: --break-system-packages

- name: Check if Meslo font directory exists
  stat:
    path: "/usr/share/fonts/Meslo"
  register: meslo_font_status

- name: Create Meslo directory if not exists
  file:
    path: /usr/share/fonts/Meslo
    state: directory

- name: Download Meslo Nerd Font
  unarchive:
    src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/Meslo.zip
    dest: "/usr/share/fonts/Meslo"
    remote_src: yes
  when: meslo_font_status.stat.exists == false

- name: Check if Inter font directory exists
  stat:
    path: "/usr/share/fonts/inter"
  register: inter_font_status

- name: Install Inter font if not present
  package:
    name: inter-font
    state: present
  when: inter_font_status.stat.exists == false

- name: Set Inter font as interface font
  dconf:
    key: "/org/gnome/desktop/interface/font-name"
    value: "'Inter Light 11'"

- name: Update Font cache 
  command: fc-cache -fv

- name: Set Inter font as document font
  dconf:
    key: "/org/gnome/desktop/interface/document-font-name"
    value: "'Inter Light 11'"

- name: Set Inter font as titlebar font
  dconf:
    key: "/org/gnome/desktop/wm/preferences/titlebar-font"
    value: "'Inter Bold 11'"

- name: Set Meslo as Terminal font
  dconf:
    key: "/org/gnome/desktop/interface/monospace-font-name"
    value: "'MesloLGS Nerd Font 10'"

- name: Uncomment the line in /etc/locale.gen
  lineinfile:
    path: /etc/locale.gen
    regexp: '^#de_AT.UTF-8 UTF-8'
    line: 'de_AT.UTF-8 UTF-8'

- name: Update locales 
  command: locale-gen

- name: Set locales with dconf
  dconf:
    key: "/system/locale/region"
    value: "'de_AT.UTF-8'"

- name: Hide unused applications from Application Launcher
  blockinfile:
    path: "/usr/share/applications/{{ item }}"
    block: |
      NoDisplay=true
    insertbefore: EOF
  with_items:
    - avahi-discover.desktop
    - bssh.desktop
    - bvnc.desktop
    - lstopo.desktop
    - htop.desktop
    - qv4l2.desktop
    - qvidcap.desktop
    - vim.desktop
    - org.gnome.Tour.desktop
    - yelp.desktop
  ignore_errors: true

- name: Get current username
  set_fact:
    current_user: "{{ lookup('env', 'USER') }}"
    
- name: Copy profile image
  copy:
    src: files/user/profile.png
    dest: "/var/lib/AccountsService/icons/{{ current_user }}"
    owner: root
    group: root
    mode: 0644

- name: users | set profile image
  lineinfile:
    path: "/var/lib/AccountsService/users/{{ current_user }}"
    regexp: '^Icon=.*'
    line: 'Icon=/var/lib/AccountsService/icons/{{ current_user }}'
    state: present

- name: remove preinstalled clutter from home directory
  file:
    path: /home/andreas/{{ item }}
    state: absent
  with_items:
    - examples.desktop
    - Desktop
    - Documents
    - Downloads
    - Music
    - Pictures
    - Public
    - Templates
    - Videos
    - Schreibtisch
    - Bilder
    - Vorlagen
    - Musik
    - Ã–ffentlich
    - Dokumente

- name: create config directories
  file:
    path: /home/{{ current_user }}/{{ item.dir }}
    state: directory
    owner: "{{ current_user }}"
    group: "{{ current_user }}"
    mode: 0700
  with_items:
    - { dir: '.config' }
    - { dir: '.config/alacritty' }
    - { dir: '.config/alacritty/themes' }
    - { dir: '.config/tmux' }
    - { dir: '.config/tmux/plugins' }
    - { dir: '.config/zsh' }

- name: create personal directories
  file:
    path: /home/{{ current_user }}/{{ item.dir }}
    state: directory
    owner: "{{ current_user }}"
    group: "{{ current_user }}"
    mode: 0700
  with_items:
    - { dir: desktop }
    - { dir: documents }
    - { dir: downloads }
    - { dir: projects }
    - { dir: scripts }
    - { dir: templates }
    - { dir: music }
    - { dir: pictures }
    - { dir: videos }

- name: copy user-dirs.dirs
  copy:
    src: files/user/user-dirs.dirs
    dest: /home/{{ current_user }}/.config/user-dirs.dirs
    owner: "{{ current_user }}"
    group: "{{ current_user }}"
    mode: 0600

- name: Check if yay directory already exists
  stat:
    path: "/home/{{ current_user }}/projects/yay"
  register: yay_status

- name: clone yay repository
  git:
    repo: https://aur.archlinux.org/yay.git
    dest: /home/{{ current_user }}/projects/yay
  when: yay_status.stat.exists == false

- name: make yay directory accessible
  file:
    path: /home/{{ current_user }}/projects/yay
    state: directory
    recurse: yes
    owner: "{{ current_user }}"
    group: "{{ current_user }}"
    mode: 0700
  when: yay_status.stat.exists == true

- name: Check if yay is installed
  command: "which yay"
  register: yay_check
  ignore_errors: true

- name: Install the yay package
  shell: yes | makepkg -si
  become: no
  args:
    chdir: "/home/{{ current_user }}/projects/yay"
  when: yay_check.rc != 0

- name: Check if auto-cpufreq directory already exists
  stat:
    path: "/home/{{ current_user }}/projects/auto-cpufreq"
  register: autocpufreq_status

- name: clone auto-cpufreq repository
  git:
    repo: https://github.com/AdnanHodzic/auto-cpufreq.git
    dest: /home/{{ current_user }}/projects/auto-cpufreq
  when: autocpufreq_status.stat.exists == false

- name: make auto-cpufreq directory accessible
  file:
    path: /home/{{ current_user }}/projects/auto-cpufreq
    state: directory
    recurse: yes
    owner: "{{ current_user }}"
    group: "{{ current_user }}"
    mode: 0700
  when: autocpufreq_status.stat.exists == true

- name: Check if auto-cpufreq is installed
  command: "which auto-cpufreq"
  register: autocpufreq_check
  ignore_errors: true

- name: Install the auto-cpufreq package
  expect:
  become: yes
  become_method: sudo
  args:
    command: ./auto-cpufreq-installer
    chdir: /home/{{ current_user }}/projects/auto-cpufreq
    responses:
      "Select a key: [i/r/q]": "i"

- name: Install auto-cpufreq daemon
  become: yes
  shell: sudo auto-cpufreq --install